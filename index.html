
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="Load and view MBTiles maps">
    <meta name="author" content="Bryan McBride">
    <title>MBTiles Viewer</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
    <link rel="stylesheet" href="assets/vendor/leaflet-1.4.0/leaflet.css">
    <link rel="stylesheet" href="assets/vendor/leaflet-locatecontrol-0.66.0/L.Control.Locate.min.css">
    <link rel="stylesheet" href="assets/vendor/fontawesome-free-5.6.1-web/css/all.min.css">
    <style>
      html, body, #map {
        height: 100%;
        width: 100%;
        margin: 0;
      }
    </style>
  </head>
  <body>
      
  <div id="map"></div>
    <script src="assets/vendor/sql.js/sql.js"></script>
    <script src="assets/vendor/leaflet-1.4.0/leaflet.js"></script>
    <script src="assets/vendor/leaflet-locatecontrol-0.66.0/L.Control.Locate.min.js"></script>
    <script src="assets/vendor/leaflet-mbtiles/Leaflet.TileLayer.MBTiles.js"></script>

    <script>
      (function() {
        L.Control.AddFile = L.Control.extend({
          onAdd: function(map) {
            fileInput = L.DomUtil.create("input", "hidden");
            fileInput.type = "file";
            fileInput.multiple = "multiple";
            fileInput.accept = ".mbtiles";
            fileInput.style.display = "none";
            // Load on file change
            fileInput.addEventListener('change', function () {
              document.getElementById("loading-icon").classList.remove("fa-globe");
              document.getElementById("loading-icon").classList.add("fa-spinner", "fa-spin");

              var file = fileInput.files[0];
              var reader = new FileReader();

              reader.onload = function(e) {
              
                var layer = L.tileLayer.mbTiles(reader.result, {
                  autoScale: true,
                  fitBounds: true
                }).on("databaseloaded", function(e) {
                  document.getElementById("loading-icon").classList.remove("fa-spin", "fa-spinner");
                  document.getElementById("loading-icon").classList.add("fa-globe");
                  controls.layerCtrl.addOverlay(layer, (layer.options.name ? layer.options.name : file.name.replace(".mbtiles", "")));
                }).addTo(map);
              }

              // reader.readAsDataURL(file);
              reader.readAsArrayBuffer(file);

              this.value = "";
            }, false);
            
            var btn = L.DomUtil.create("div", "leaflet-bar leaflet-control");
            // btn.innerHTML = "<button style='height: 30px; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; background-color: #fff; font-size: medium;' onclick='fileInput.click();'><i id='loading-icon' class='fas fa-folder-open'></i></button>";
            btn.innerHTML = '<a class="leaflet-bar-part leaflet-bar-part-single" style="font-size: 1.4em; color: #444; cursor: pointer;" title="Load MBTiles" onclick="fileInput.click();"><i id="loading-icon" class="fas fa-globe"></i></a>';
            return btn
          }
        });

        L.control.addfile = function(opts) {
          return new L.Control.AddFile(opts);
        }
        
        var map = L.map("map", {
          zoomControl: false,
          zoomSnap: 0.5,
          maxZoom: 22
        }).fitWorld();
        map.attributionControl.setPrefix(null);

        var basemaps = {
          osm: L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.@2xpng", {
            maxZoom: 18,
            attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, © <a href="https://carto.com/attribution">CARTO</a>',
          }).addTo(map),

          topo: L.tileLayer("https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}", {
            maxZoom: 18,
            maxNativeZoom: 16,
            attribution: "USGS",
          }),

          charts: L.tileLayer("https://tileservice.charts.noaa.gov/tiles/50000_1/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: "NOAA",
          }),

          none: L.tileLayer("")
        };

        var controls = {
          layerCtrl: L.control.layers({
            "OpenStreetMap": basemaps.osm,
            "USGS Topo": basemaps.topo,
            "NOAA Charts": basemaps.charts,
            "None": basemaps.none
          }, null, {
            position: "topleft"
          }).addTo(map),

          locateCtrl: L.control.locate({
            icon: "fa fa-crosshairs",
            setView: "untilPan",
            cacheLocation: true,
            position: "topright",
            flyTo: false,
            circleStyle: {
              interactive: false
            },
            markerStyle: {
              interactive: false
            },
            locateOptions: {
              enableHighAccuracy: true,
              maxZoom: 17
            },
            onLocationError: function(e) {
              alert("Geolocation error: " + e.message);
            }
          }).addTo(map),

          addFileCtrl: L.control.addfile({
            position: "topright"
          }).addTo(map)
        };

        var urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has("file")) {
          loadURLFile(urlParams.get("file"));
        } else {
          controls.locateCtrl.start();
        }

        function loadURLFile(url) {
          var url = urlParams.get("file");
          var name = urlParams.get("name") ? urlParams.get("name") : "Unnamed";
          document.getElementById("loading-icon").classList.remove("fa-globe");
          document.getElementById("loading-icon").classList.add("fa-spinner", "fa-spin");
          var layer = L.tileLayer.mbTiles(url, {
            autoScale: true,
            fitBounds: true
          }).on("databaseloaded", function(e) {
            document.getElementById("loading-icon").classList.remove("fa-spin", "fa-spinner");
            document.getElementById("loading-icon").classList.add("fa-globe");
            controls.layerCtrl.addOverlay(layer, name);
          }).addTo(map);
        }

        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("service-worker.js");
        }

        window["map"] = map;
      })();
    </script>
  </body>
</html>